<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一个机缘巧合的 bug | linrz</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.acc6a2b2.css" as="style"><link rel="preload" href="/assets/js/app.cc523793.js" as="script"><link rel="preload" href="/assets/js/3.2679e287.js" as="script"><link rel="preload" href="/assets/js/7.2fd78d9b.js" as="script"><link rel="preload" href="/assets/js/5.57eef5f1.js" as="script"><link rel="prefetch" href="/assets/js/1.c3becc9f.js"><link rel="prefetch" href="/assets/js/10.d56f6661.js"><link rel="prefetch" href="/assets/js/11.fb5f77c3.js"><link rel="prefetch" href="/assets/js/12.0a63a870.js"><link rel="prefetch" href="/assets/js/13.4b8c6211.js"><link rel="prefetch" href="/assets/js/14.ecfe77ef.js"><link rel="prefetch" href="/assets/js/15.ad276c1c.js"><link rel="prefetch" href="/assets/js/16.bf6ce550.js"><link rel="prefetch" href="/assets/js/17.7a99240a.js"><link rel="prefetch" href="/assets/js/4.b37e7fdf.js"><link rel="prefetch" href="/assets/js/6.44fcac8b.js"><link rel="prefetch" href="/assets/js/8.854dbf3e.js"><link rel="prefetch" href="/assets/js/9.2f1d8b89.js">
    <link rel="stylesheet" href="/assets/css/0.styles.acc6a2b2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="cute-nav"><div class="cute-nav-left"><a href="/">linrz</a></div> <div class="cute-nav-right"><div class="cute-nav-item cute-nav-active"><a href="/">Blog</a></div><div class="cute-nav-item "><a href="/about">About</a></div></div></div> <div class="cute-content"><div class="cute-page-header"><div class="cute-page-title">一个机缘巧合的 bug</div> <div class="cute-page-subtitle"><span class="cute-page-date">09/16 2019</span> <span>☕️</span> <span>4 min read</span></div></div> <div class="cute-page-markdown"><div slot="default" class="markdown-body content default"><p>中秋节前的最后一个工作日的晚上，同事突然和我说有个 css 文件打包完没传到 cdn 上去，其他 js css 文件都自动传上去了。
有点震惊，第一反应是打包机器上没生成这个文件，细看了下打包日志是有的，登到机器上也是有这个 css 文件的，
一路跟踪到 cdn 的包发现把这个 css 文件识别为了 video/mp2t 类型的文件了，和后缀名不一样阻止了上传。</p> <p>css 外链在<a href="http://img.lastwhisper.cn/test.css" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">._2PGf0jspAi_j4kPchLai3f</span><span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span>flex<span class="token punctuation">;</span><span class="token property">justify-content</span><span class="token punctuation">:</span>flex-start<span class="token punctuation">;</span><span class="token property">align-items</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>10px<span class="token punctuation">}</span><span class="token selector">._2PGf0jspAi_j4kPchLai3f .stage-item</span><span class="token punctuation">{</span><span class="token property">padding-top</span><span class="token punctuation">:</span>5px<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>1<span class="token punctuation">;</span><span class="token property">text-align</span><span class="token punctuation">:</span>center<span class="token punctuation">}</span><span class="token selector">._2PGf0jspAi_j4kPchLai3f .stage-item__indicator</span><span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span>block<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>0 auto<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span>50%<span class="token punctuation">;</span><span class="token property">text-align</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>12px<span class="token punctuation">;</span><span class="token property">background-color</span><span class="token punctuation">:</span>#155bd4<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#fff<span class="token punctuation">}</span><span class="token selector">._2PGf0jspAi_j4kPchLai3f .stage-item__name</span><span class="token punctuation">{</span><span class="token property">margin-top</span><span class="token punctuation">:</span>10px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>12px<span class="token punctuation">}</span><span class="token selector">._2PGf0jspAi_j4kPchLai3f .stage__arrow</span><span class="token punctuation">{</span><span class="token property">position</span><span class="token punctuation">:</span>relative<span class="token punctuation">;</span><span class="token property">box-sizing</span><span class="token punctuation">:</span>content-box<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>45px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>2px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>14px 17px 0 10px<span class="token punctuation">;</span><span class="token property">align-self</span><span class="token punctuation">:</span>flex-start<span class="token punctuation">;</span><span class="token property">background-color</span><span class="token punctuation">:</span>#38f<span class="token punctuation">}</span><span class="token selector">._2PGf0jspAi_j4kPchLai3f .stage__arrow:after</span><span class="token punctuation">{</span><span class="token property">content</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span><span class="token property">position</span><span class="token punctuation">:</span>absolute<span class="token punctuation">;</span><span class="token property">top</span><span class="token punctuation">:</span>50%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">margin-top</span><span class="token punctuation">:</span>-6px<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>solid transparent<span class="token punctuation">;</span><span class="token property">border-left</span><span class="token punctuation">:</span>solid #38f<span class="token punctuation">;</span><span class="token property">border-width</span><span class="token punctuation">:</span>6px 0 6px 7px<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__control</span><span class="token punctuation">{</span><span class="token property">margin-top</span><span class="token punctuation">:</span>10px<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__input</span><span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span>inline-block<span class="token punctuation">;</span><span class="token property">margin-right</span><span class="token punctuation">:</span>10px<span class="token punctuation">;</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>0<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__input .zent-input</span><span class="token punctuation">{</span><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">min-width</span><span class="token punctuation">:</span>0<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__input .retail-form__controls</span><span class="token punctuation">{</span><span class="token property">width</span><span class="token punctuation">:</span>60px<span class="token punctuation">;</span><span class="token property">overflow</span><span class="token punctuation">:</span>visible<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__input .retail-form__input-normal,._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__input .retail-form__number-input-normal,._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__input .retail-form__select-normal</span><span class="token punctuation">{</span><span class="token property">width</span><span class="token punctuation">:</span>auto<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__input .retail-form__error-desc</span><span class="token punctuation">{</span><span class="token property">white-space</span><span class="token punctuation">:</span>nowrap<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__select</span><span class="token punctuation">{</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">margin-right</span><span class="token punctuation">:</span>10px<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__select .retail-form__controls</span><span class="token punctuation">{</span><span class="token property">width</span><span class="token punctuation">:</span>80px<span class="token punctuation">;</span><span class="token property">overflow</span><span class="token punctuation">:</span>visible<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__select .retail-form__error-desc</span><span class="token punctuation">{</span><span class="token property">white-space</span><span class="token punctuation">:</span>nowrap<span class="token punctuation">}</span><span class="token selector">._1st9tZWOTTVEsG6xGsMBgZ .auto-handle__list</span><span class="token punctuation">{</span><span class="token property">margin-left</span><span class="token punctuation">:</span>10px<span class="token punctuation">}</span><span class="token selector">._26IN1KgKwuC-8Ke2AWLQMd</span><span class="token punctuation">{</span><span class="token property">min-width</span><span class="token punctuation">:</span>350px<span class="token punctuation">}</span><span class="token selector">._26IN1KgKwuC-8Ke2AWLQMd hr</span><span class="token punctuation">{</span><span class="token property">margin</span><span class="token punctuation">:</span>5px 0<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token property">border-bottom</span><span class="token punctuation">:</span>1px solid #d9d9d9<span class="token punctuation">}</span><span class="token selector">._26IN1KgKwuC-8Ke2AWLQMd .stage-help__desc</span><span class="token punctuation">{</span><span class="token property">font-size</span><span class="token punctuation">:</span>12px<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#999<span class="token punctuation">}</span><span class="token selector">._26IN1KgKwuC-8Ke2AWLQMd .retail-form__control-group-label</span><span class="token punctuation">{</span><span class="token property">width</span><span class="token punctuation">:</span>auto<span class="token punctuation">}</span><span class="token selector">._26IN1KgKwuC-8Ke2AWLQMd .auto-handle</span><span class="token punctuation">{</span><span class="token property">margin-top</span><span class="token punctuation">:</span>10px<span class="token punctuation">}</span><span class="token selector">._26IN1KgKwuC-8Ke2AWLQMd .auto-handle-switch__control,._26IN1KgKwuC-8Ke2AWLQMd .on-switch__control</span><span class="token punctuation">{</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">vertical-align</span><span class="token punctuation">:</span>middle<span class="token punctuation">}</span><span class="token selector">._3y7sb0SRH3jy04vT8SwvdB</span><span class="token punctuation">{</span><span class="token property">max-width</span><span class="token punctuation">:</span>300px<span class="token punctuation">}</span><span class="token selector">._3ay_Klg6rEZWa9QDGWnmKm</span><span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span>block<span class="token punctuation">}</span><span class="token selector">._3ay_Klg6rEZWa9QDGWnmKm .lifecycle-field-row</span><span class="token punctuation">{</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>30px<span class="token punctuation">}</span><span class="token selector">._2w74Sl2jmM-ZIs0rGMCXFC</span><span class="token punctuation">{</span><span class="token property">margin-top</span><span class="token punctuation">:</span>10px<span class="token punctuation">}</span><span class="token selector">._2w74Sl2jmM-ZIs0rGMCXFC .sync-item</span><span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span>flex<span class="token punctuation">;</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>1<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">}</span><span class="token selector">._2w74Sl2jmM-ZIs0rGMCXFC .sync-item:last-child</span><span class="token punctuation">{</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>0<span class="token punctuation">}</span><span class="token selector">._2w74Sl2jmM-ZIs0rGMCXFC .sync-item__label</span><span class="token punctuation">{</span><span class="token property">width</span><span class="token punctuation">:</span>45px<span class="token punctuation">;</span><span class="token property">border-right</span><span class="token punctuation">:</span>1px solid #e5e5e5<span class="token punctuation">;</span><span class="token property">margin-right</span><span class="token punctuation">:</span>20px<span class="token punctuation">}</span><span class="token selector">._2JD-or1FCe_3hu_6UY1o8d .lifecycle-field-group</span><span class="token punctuation">{</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>0<span class="token punctuation">}</span><span class="token selector">._2JD-or1FCe_3hu_6UY1o8d .no-auth-alert</span><span class="token punctuation">{</span><span class="token property">margin</span><span class="token punctuation">:</span>15px<span class="token punctuation">}</span>
</code></pre></div><p>看了下源码是怎么识别文件类型的，一看原来是 sindresorhus 写的 <a href="https://github.com/sindresorhus/file-type/" target="_blank" rel="noopener noreferrer">file-type<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，也是读 buffer 根据文件头判断的，目前<a href="https://github.com/sindresorhus/file-type/blob/2f696447cdec530223ae0f8db4e871c8312922ee/index.js" target="_blank" rel="noopener noreferrer">最新的提交代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>第 856 行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x47</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>offset<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x47</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>offset<span class="token punctuation">:</span> <span class="token number">192</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x47</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>offset<span class="token punctuation">:</span> <span class="token number">196</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>当满足这个条件时即被认为是 mp2t 文件，check 函数的功能是校验文件头，符合定义即是对应文件。</p> <p>我们再看维基百科对 <a href="https://zh.wikipedia.org/wiki/MPEG2-TS" target="_blank" rel="noopener noreferrer">mp2t<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文件的定义:</p> <blockquote><p>每个TS分组以固定的同步字节起始，这个同步字节的值为0x47，它也是TS分组头的一部分。TS分组的必选头长度为4字节，其后为可选部分，为载荷或适配域。TS分组的头部固定以大端序读写。TS分组长度为188字节。</p></blockquote> <p>值为 0x47， 长度为 4 字节，是不是瞬间懂了，写个 demo 验证下</p> <p><img src="http://img.lastwhisper.cn/file-code.png" alt="file-code"> <img src="http://img.lastwhisper.cn/file-result.png" alt="file-result"></p> <p>确实如此，那后面校验第 192 位和 196 位又是为什么呢，192 个人猜测是分组长度加上固定的头长度四字节，用上面的代码改下 index 确实也是 0x47。转成字符后是 <code>G</code>，上面的 css 第 4 位即第 5 个字符确实是 G，第 193 个字符也确实 G，经过 css module 混淆过后的 class 名字前后的位置上恰巧都是 G，emmm...</p> <p>还有个或的条件是 196 位，再看维基百科也是有相关说明：</p> <blockquote><p>MPEG-2 TS原本的设计用途是数字电视广播，不过后来用在数字摄像机、录像机、播放机上。用于非广播类用途时，其TS分组格式有所不同：在分组上增加了4个字节长的时间码（Time Code），使分组长度变为192字节</p></blockquote> <p>所以这个判断条件也是没问题的。这个 bug 由于两个位置恰巧都满足了条件被误判为 mp2t 文件实在是巧合，有点啼笑皆非 😅</p></div></div> <!----></div> <div class="cute-footer cute-content"><div class="cute-footer-copyright">
    © linrz Themed By <a target="_blank" href="https://github.com/linrz/vuepress-theme-cute">vuepress-theme-cute</a></div> <div class="cute-footer-hills"></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cc523793.js" defer></script><script src="/assets/js/3.2679e287.js" defer></script><script src="/assets/js/7.2fd78d9b.js" defer></script><script src="/assets/js/5.57eef5f1.js" defer></script>
  </body>
</html>
